projects:
  - name: Crowd Sourced Travel Planner
    environments:
      # Production
      - name: Production
        permissions:
          protection: enabled
        services:
          - type: web
            name: server-prod
            runtime: node
            region: oregon
            branch: main
            plan: starter # $7/month (otherwise, the server can have downtime)
            numInstances: 1
            rootDir: server

            buildCommand: |
              npm ci

              # build client and place it in public for the server to serve
              # so it can hydrate the session on first render
              cd ../client
              npm ci
              npm run build
              mkdir ../server/public
              rm -rf ../server/public/*
              cp -r ./dist/* ../server/public

            startCommand: npm start
        databases:
          - name: db-prod
            plan: basic-256mb # $6/month + also, can only have 1 free DB
            region: oregon

      # Development
      - name: Development
        services:
          - type: web
            name: server-dev
            runtime: node
            region: oregon
            branch: dev
            plan: free
            numInstances: 1
            rootDir: server

            buildCommand: |
              pip install --upgrade pip
              pip install pipenv
              pipenv install --deploy --ignore-pipfile

              # build client and place it in public for backend to serve
              # so it can hydrate the session on first render
              cd ../client
              npm ci
              npm run build
              mkdir ../server/public
              rm -rf ../server/public/*
              cp -r ./dist/* ../server/public

            startCommand: npm start # TODO: fixme later -
        databases:
          - name: db-dev
            region: oregon
            plan: free
